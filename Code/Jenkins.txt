def pompath = "Code"
pipeline {
    agent any 
	     environment {
			PATH = "C:\\WINDOWS\\SYSTEM32"
		}
	parameters { choice(name: 'REQUESTED_ACTION', choices: ['Package', 'Sonar Analysis'], description: '') }
    stages {
        stage('Checkout from SCM ') { 
            steps {
               git credentialsId: 'GitHub_Credential_raghav', url: 'https://github.com/jha-raghav/HappyTrip.git'
            }
        }
		stage('Build') {
			 tools {
	           jdk 'JDK8'
	           maven 'Maven'
	 }
	     when {
                expression { params.REQUESTED_ACTION == 'Package' }
            }
		  steps {
		  dir(pompath) {
                  bat 'mvn package'
				  archiveArtifacts 'target/*.war'
}
		       
		   }
		}
		 def selectedchoice = input(message: 'Do you want to trigger release for the current Artefacts ?', ok: 'Yes', 
                        parameters: [ booleanParam(name: 'RELEASE' defaultValue: false, 
                        description: '')])
						
			stage('Deploy to PROD') { 
			def tomcatdirectory = "C:\Program Files\Apache Software Foundation\Tomcat 7.0"
			if(selectedchoice == true){
	        steps {
               bat 'copy target\*.war tomcatdirectory\webapps\'
            }
			}

        }			
			stage('Build and Sonar Analysis') {
			 tools {
	           jdk 'JDK8'
	           maven 'Maven'
	 }
	     when {
                expression { params.REQUESTED_ACTION == 'Sonar Analysis' }
            }
		  steps {
		  withSonarQubeEnv('SonarQube Server') {
		  dir(pompath) {
                    bat 'mvn package sonar:sonar'
}
}
		       
		   }
		}
       
    }
}
